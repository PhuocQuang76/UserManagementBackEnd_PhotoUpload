---
- name: Complete Jenkins Installation (Direct .deb)
  hosts: jenkins_server
  become: true
  gather_facts: true  # Make sure we collect all facts

  tasks:
    # Update package list
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    # Install Java 21 JDK
    - name: Install Java 21 JDK
      apt:
        name: openjdk-21-jdk
        state: present
        update_cache: yes

    # Install Maven
    - name: Install Maven
      apt:
        name: maven
        state: present

    # Download Jenkins .deb package directly
    - name: Download Jenkins
      get_url:
        url: https://pkg.jenkins.io/debian-stable/binary/jenkins_2.440.1_all.deb
        dest: /tmp/jenkins.deb
        mode: '0644'

    # Install Jenkins from .deb file
    - name: Install Jenkins from .deb
      apt:
        deb: /tmp/jenkins.deb
        install_recommends: no

    # Start and enable Jenkins
    - name: Start Jenkins service
      systemd:
        name: jenkins
        state: started
        enabled: yes

    # Simple firewall rule (skipped if UFW not installed)
    - name: Check if UFW is installed
      stat:
        path: /usr/sbin/ufw
      register: ufw_installed

    - name: Allow Jenkins port in firewall
      ufw:
        rule: allow
        port: '8080'
        proto: tcp
      when: ufw_installed.stat.exists

    # Wait for Jenkins to be fully up
    - name: Wait for Jenkins to be ready
      uri:
        url: http://localhost:8080
        status_code: 200, 403
      register: jenkins_ready
      until: jenkins_ready.status in [200, 403]
      retries: 10
      delay: 10
      ignore_errors: yes

    # Get initial admin password
    - name: Get initial admin password
      command: cat /var/lib/jenkins/secrets/initialAdminPassword
      register: jenkins_password
      changed_when: false
      retries: 5
      delay: 10
      until: jenkins_password.rc == 0

    # Show installation summary
    - name: Show installation summary
      debug:
        msg: |
          ===== Jenkins Installation Complete =====
          Jenkins is now running on: http://{{ ansible_host }}:8080
          Initial admin password: {{ jenkins_password.stdout | default('Run: sudo cat /var/lib/jenkins/secrets/initialAdminPassword') }}
          =======================================

    # Verify installations
    - name: Verify Java installation
      command: java -version
      register: java_version
      changed_when: false
      ignore_errors: yes

    - name: Verify Maven installation
      command: mvn -version
      register: maven_version
      changed_when: false
      ignore_errors: yes

    - name: Show versions
      debug:
        msg:
          - "Java version: {{ java_version.stderr | default('Not found') | regex_replace('\n', '') }}"
          - "Maven version: {{ maven_version.stdout | default('Not found') | regex_replace('\n', '') }}"
          - "Jenkins service status: {{ 'Running' if jenkins_ready is defined and jenkins_ready.status in [200, 403] else 'Not running' }}"