---
- name: Complete Jenkins Installation (Direct .deb)
  hosts: jenkins_server
  become: true
  gather_facts: true

  tasks:
    # Update package list
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    # Install Java 21 JDK
    - name: Install Java 21 JDK
      apt:
        name: openjdk-21-jdk
        state: present
        update_cache: yes

    # Install Maven
    - name: Install Maven
      apt:
        name: maven
        state: present

    # Jenkins Repository and Installation
    - name: Add Jenkins repository key
      apt_key:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io-2026.key
        state: present

    - name: Add Jenkins repository
      apt_repository:
        repo: "deb https://pkg.jenkins.io/debian-stable binary/"
        state: present
        filename: jenkins
        update_cache: yes

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present
        update_cache: yes

    - name: Ensure Jenkins service is running
      service:
        name: jenkins
        state: started
        enabled: yes

    # Wait for Jenkins to be ready
    - name: Wait for Jenkins to start
      uri:
        url: http://localhost:8080
        status_code: 403
      register: jenkins_ready
      retries: 12
      delay: 10
      until: jenkins_ready.status == 200 or jenkins_ready.status == 403
      ignore_errors: yes

    # Get initial admin password
    - name: Get initial admin password
      command: cat /var/lib/jenkins/secrets/initialAdminPassword
      register: jenkins_password
      changed_when: false
      retries: 5
      delay: 10
      until: jenkins_password.rc == 0

    # Show installation summary
    - name: Show installation summary
      debug:
        msg: |
          ===== Jenkins Installation Complete =====
          Jenkins is now running on: http://{{ ansible_host }}:8080
          Initial admin password: {{ jenkins_password.stdout | trim }}
          =======================================

    # Verify installations
    - name: Verify Java installation
      command: java -version
      register: java_version
      changed_when: false
      ignore_errors: yes

    - name: Verify Maven installation
      command: mvn -version
      register: maven_version
      changed_when: false
      ignore_errors: yes

    - name: Show versions
      debug:
        msg:
          - "Java version: {{ (java_version.stderr | default(java_version.stdout) | regex_replace('\n', ' ')) | trim }}"
          - "Maven version: {{ (maven_version.stderr | default(maven_version.stdout) | regex_replace('\n', ' ')) | trim }}"
          - "Jenkins service status: {{ 'Running' if jenkins_ready is defined and jenkins_ready.status in [200, 403] else 'Not running' }}"